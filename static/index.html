<!DOCTYPE html>
<html>
<head>
  <title>AR Overlay Debug</title>
  <style>
    video, canvas, img {
      width: 100%;
      max-width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Point your camera to the marker</h2>
  <div id="log" style="color:red;"></div>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display: none;"></canvas>
  <img id="output" />

  <script>
    const logDiv = document.getElementById("log");
    const log = (msg) => {
      console.log(msg);
      logDiv.innerText += msg + "\n";
    };

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const output = document.getElementById("output");

    // 1. Request camera access
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        log("✅ Camera access granted.");
        startWebSocket();
      })
      .catch(err => {
        log("❌ Camera access denied.");
        console.error(err);
      });

    // 2. Connect WebSocket and send frames
    function startWebSocket() {
      const ws = new WebSocket(`ws://${location.host}/ws`);
      ws.onopen = () => log("✅ WebSocket connected.");

      ws.onerror = (err) => {
        log("❌ WebSocket error.");
        console.error(err);
      };

      ws.onmessage = (event) => {
        if (event.data.startsWith("data:image")) {
          output.src = event.data;
        }
      };

      setInterval(() => {
        if (video.readyState >= 2) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const frame = canvas.toDataURL("image/jpeg");
          ws.send(frame);
        }
      }, 200);
    }
  </script>
</body>
</html>
